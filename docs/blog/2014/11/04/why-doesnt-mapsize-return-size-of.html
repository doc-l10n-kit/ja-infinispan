<!DOCTYPE html>
<html>

<head>
  <title>Why doesn't Map.size return the size of the entire cluster?</title>
  <!-- <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script> -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Infinispan is a distributed in-memory key/value data store with optional schema, available under the Apache License 2.0.">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet"
        href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github-dark.min.css">
  <link rel="alternate" type="application/rss+xml"
        title="Infinispan's RSS Feed"
        href="/feed.xml" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
          
  <!-- Global site tag (gtag.js) - Google Analytics -->
<!--   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125236544-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-125236544-1');
  </script> -->


</head>

<body class="blog">
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/infinispan-logo-white.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/learn/">学ぶ <i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/introduction" class="">入門</a></li>
          <li><a href="/features" class="">機能</a></li>
          <li><a href="/documentation" class="">ドキュメンテーション</a></li>
          <li><a href="/tutorials" class="">チュートリアル</a></li>
          <li><a href="/videos" class="">ビデオ</a></li>
          <li><a href="/references" class="">参考資料</a></li>
          <li><a href="/experiments" class="">実験</a></li>
          <li><a href="/roadmap" class="">ロードマップ</a></li>
        </ul>
      </li>
      <li>
        <a href="/use-cases/" class="">使用事例</a>
      </li>
      <li>
        <a href="/community/" class="">コミュニティ</a>
      </li>
      <li>
        <a href="/blog/" class="active">Blog</a>
      </li>
      <li>
        <a href="/download/" class="">ダウンロード</a>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    
<div class="component-slim full-width-bg dark-bg light-blue">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <a href="/blog">Blogs</a>  <i class="fas fa-chevron-right"></i> Why doesn't Map.size return the size of the entire cluster?
    </div>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="grid__item width-10-12 width-12-12-m doc-content">
    <h1>Why doesn't Map.size return the size of the entire cluster?</h1>
    <div class="post-date">November 04, 2014
      Tags: 
    </div>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m margin-tb-sm">
        <div class="grid-wrapper">
          <div class="width-2-12 justify-self-center align-self-center">
            <img src="/assets/images/blog/authors/infinispan.jpg">
          </div>
          <div class="width-10-12 align-self-center">
            <p class="byline">By Infinispan</p>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>Many people may have been surprised the first time they used Map.size method
on a distributed Infinispan cluster.  As was later deduced only the local
node size is returned.</p>
</div>
<div class="paragraph">
<p>Infinispan had taken this approach to limit the chance that instead of
getting the full cluster size you would receive an OutOfMemoryError.  This
seems fair to return the local answer only but you secretly always wanted
the entire cluster size.</p>
</div>
<div class="paragraph">
<p>For the
<a href="http://blog.infinispan.org/2014/11/infinispan-700final-is-out.html">Infinispan
7.0.0.Final release</a> forget what you know when using the Map interface with
Infinispan.</p>
</div>
<div class="paragraph">
<p>==</p>
</div>
<div class="sect1">
<h2 id="enter-distributed-entry-iterator">Enter Distributed Entry Iterator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We already announced this feature a while back at
<a href="http://blog.infinispan.org/2014/05/iterate-all-entries-in-cache.html. " class="bare">http://blog.infinispan.org/2014/05/iterate-all-entries-in-cache.html. </a> You
can check it out for more details but it is essentially a memory efficient
way of retrieving all the entries in the cache by iterating over them.</p>
</div>
<div class="paragraph">
<p>This has opened the way to implementing the various bulk methods on the Map
interface that we could never do efficiently in the past (ie.  Map.size,
Map.keySet, Map.entrySet &amp; Map.values).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="map-size">Map size</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Okay I admit, size could have been done more efficiently before, but the
answer would have contained a very high margin of error.  Now size will give
you a size value with consistency semantics just slightly less than
ConcurrentHashMap does, but for the entire cluster.  Warning should be given
that size may be slower for larger clusters or ones with a lot of data in a
stored cache loader.</p>
</div>
<div class="paragraph">
<p>The size method behavior can be controlled by using a supplied
<a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag&#8230;&#8203;%29">Flag</a>
such as SKIP_CACHE_LOAD to not count any configured cache loaders or
CACHE_MODE_LOCAL if you want the local count only.  These flags are not
exclusive and can be both passed if desired as well.</p>
</div>
<div class="paragraph">
<p>==</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="map-collection-views">Map Collection Views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the past the Map.values, Map.keySet &amp; Map.entrySet methods were only ever
in memory copies of the local data at the time they were invoked, similar to
Map.size.</p>
</div>
<div class="paragraph">
<p>Now these collection views will be cluster wide and an additionally will
show updated contents when the cache is updated and your writes to the
collection will be reflected in the Cache itself!  The only operations you
can&#8217;t do on these collections are adding values to either the keySet or
values collections as they aren&#8217;t key/value pairs.</p>
</div>
<div class="paragraph">
<p>If your cache was configured with a Flag such as SKIP_CACHE_LOAD or
CACHE_MODE_LOCAL it will also be reflected in the collection view for both
reads and writes.</p>
</div>
<div class="paragraph">
<p>Some caution is advised when using toArray, retainAll, or size methods as
they will require full iteration to complete.</p>
</div>
<div class="paragraph">
<p><strong>KeySet Optimization</strong></p>
</div>
<div class="paragraph">
<p>The key set collection also has an optimization so it will never pull down
the values so it has a lower network and serialization/deserialization
overhead (unlike entrySet and values).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactionality">Transactionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All of the aforementioned methods still support transactions in a way that
you would expect.  There is one guarantee we don&#8217;t provide and that is when
using REPEATABLE_READ isolation.  We will not store entries read from an
iterator in the transactional context as this could very easily run your
local node out of memory with a large enough data set.</p>
</div>
<div class="paragraph">
<p>For reference methods that use an iterator internally are toArray,
retainAll, isEmpty &amp; size on the various collections as well as contains and
containsAll on the values collection.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="other-api-changes">Other API Changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These changes have also loosened some restrictions on other methods as well.</p>
</div>
<div class="sect2">
<h3 id="map-isempty">Map.isEmpty</h3>
<div class="paragraph">
<p>This method before was only used locally as it used to calculate the size to
determine if it was empty.  This method will now use the entry iterator and
returns as soon as it finds that even a single value exists.  This is an
important change as the old implementation would have to query any
configured Cache Loader&#8217;s complete size before returning.</p>
</div>
</div>
<div class="sect2">
<h3 id="map-containsvalue">Map.containsValue</h3>
<div class="paragraph">
<p>We never supported this method before (not even locally).  This method will
now use the iterator though and if it finds the value at any point point
will return immediately so it doesn&#8217;t have to iterate over the entire
contents unless they don&#8217;t exist.  However if you really want to do this
operation often you should really use
<a href="http://infinispan.org/docs/7.0.x/user_guide/user_guide.html#sid-68355061">Indexing</a>
to make this faster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="code-examples">Code Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I could put an example here, but I think some could take it as insult.  You
have already seen 100&#8217;s of examples as to how to use the Map interface and
now in Infinispan you can use those in the exact same way and they will work
just how you would expect them to.</p>
</div>
</div>
</div>
          
      </div>
      <div class="grid__item width-12-12">
        <h2>手に入れて、使って、尋ねて！ </h2>
現在、新機能、改善、修正に取り組んでいますので、今後の発表にご期待ください。
<div class="paragraph">
    <p>最新のリリースを<a href="/download" target="_blank">ダウンロード</a>してお試しください。</p>
</div>
<div class="paragraph">
    <p>ソースコードは<a href="" target="_blank">GitHub</a>でホストされています。
        バグを報告したり、新機能を要求したりする必要がある場合は、<a href="https://issues.jboss.org/browse/ISPN" target="_blank">JIRA課題監視</a>で同様のものを探してください。
        見つからない場合は、<a href="https://issues.jboss.org/browse/ISPN" target="_blank">新しい課題を作成してください</a>。</p>
</div>
<div class="paragraph">
    <p>質問があったり、バグが発生していたり、Infinispanを使う上でのアドバイスが欲しい場合は、
        <a href="https://stackoverflow.com/questions/tagged/?tagnames=infinispan&sort=newest"
                       target="_blank">StackOverflow</a>をご利用ください。
        できる限り早く回答するように努めます。</p>
</div>
<div class="paragraph">
    <p>Infinispanのコミュニティでは、リアルタイムのコミュニケーションに<a href="https://zulipchat.com/"
                                        target="_blank">Zulip</a>を使用しています。
        Webブラウザまたは<a href="https://infinispan.zulipchat.com/" target="_blank">Infinispanチャット</a>上の
         <a href="https://infinispan.zulipchat.com/apps/" target="_blank">専用のアプリケーション</a>を使って参加してください。</p>
</div>
      </div>
      
      <div class="width-12-12 callout orange margin-tb-xs">
    <div class="grid-wrapper">
        <div class="width-4-12 width-12-12-m block-image">
            <img src="/assets/images/blog/authors/infinispan.jpg" class="author-img">
        </div>
        <div class="width-8-12 width-12-12-m block-content">
            <h5>Infinispan</h5>
            <p>2009年からパフォーマンスを向上させています。</p>
            <div class="width-3-12 width-6-12-m bio-block">
                <a href="http://github.com/infinispan"><img src="/assets/images/community/icon-github.png"></a>
                
                <a href="http://twitter.com/infinispan"><img src="/assets/images/community/icon-twitter.png"></a>
                
            </div>
        </div>
    </div>
</div>
      
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/infinispan-logo.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">InfinispanはApache 2.0オープンソースライセンスでリリースされています。<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>についての詳細はこちらをご覧ください。<br/><br/><a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>で構築されたこのウェブサイトは<a href='https://pages.github.com/' target='_blank'>Github Pages</a>でホストされており、完全にオープンソースです。より良いものにしたいのであれば、<a href='https://github.com/infinispan/infinispan.github.io' target='_blank'>このウェブサイトをフォーク</a>して、あなたが得たいものを私たちに見せてください。</p>

    
      <div class="width-1-12 project-links">
        <b>ナビゲーション</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/" >Home</a></li>
          
            
            <li><a href="/features" >機能</a></li>
          
            
            <li><a href="/documentation" >ドキュメント</a></li>
          
            
            <li><a href="/tutorials" >チュートリアル</a></li>
          
            
            <li><a href="/videos" >ビデオ</a></li>
          
            
            <li><a href="/use-cases" >使用例</a></li>
          
            
            <li><a href="/community" >コミュニティ</a></li>
          
            
            <li><a href="/download" >ダウンロード</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>貢献</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="https://issues.jboss.org/browse/ISPN" target="_blank">バグ登録</a></li>
          
            
            <li><a href="https://github.com/infinispan" target="_blank">コードを書く</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>私たちをフォロー</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/blog" >Blog</a></li>
          
            
            <li><a href="https://twitter.com/infinispan" target="_blank">Twitter</a></li>
          
        </ul>
      </div>
    

    <div class="width-6-12 more-links">
      <div class="grid-wrapper">
        <div class="width-6-12">
          <b>A Member of</b><br/>
          <a href="http://www.cloudtm.eu/" target="_blank"><img src="/assets/images/footer/cloud-tm.png"></a>
          <img src="/assets/images/footer/leads.png">
          <br/>
          <a href="http://cloudbutton.eu/" target="_blank"><img src="/assets/images/footer/cloud-button.png"></a>

        </div>
        <div class="width-6-12">

          <b>Thanks to</b><br/>
          <a href="https://www.jetbrains.com/idea/" target="_blank"><img src="/assets/images/footer/jetbrains.png" title="JetBrains Intellj IDEA"></a>
          <a href="https://weblate.org" target="_blank"><img src="/assets/images/footer/weblate.png" title="Weblate"></a>
        </div>
      </div>
    </div>
  </div>
</div>
  <div class="content-slim redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
      | <a href="https://www.redhat.com/en/about/privacy-policy">Red Hat Privacy Policy</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/truncate-list.js"></script>

  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>

<!--   <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script> -->
</body>

</html>
